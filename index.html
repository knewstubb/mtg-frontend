<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Commander Simulator - Game Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        /* Simple transition for smoother appearance */
        .ui-panel {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-white antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-100">MTG Commander Simulator</h1>
            <p class="text-xl text-gray-400 mt-2">Phase 2: Game Engine Integration</p>
        </header>

        <main>
            <!-- Deck Importer -->
            <div id="importer-panel" class="bg-gray-800 rounded-lg shadow-xl p-6 ui-panel">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Create New Game</h2>
                <p class="text-gray-300 mb-4">Paste a public Moxfield or Archidekt deck URL to begin.</p>
                 <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="deck-url-input" placeholder="Moxfield or Archidekt URL" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md px-4 py-2 focus:ring-2 focus:ring-green-500 focus:outline-none placeholder-gray-500">
                    <button id="import-deck-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition-transform transform hover:scale-105">
                        Create Game
                    </button>
                </div>
            </div>

            <!-- Game Display Panel -->
            <div id="game-panel" class="hidden mt-8 ui-panel">
                 <!-- Loader -->
                <div id="loader" class="hidden text-center py-8">
                    <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-400 text-lg" id="loader-text">Loading...</p>
                </div>
                
                <!-- Error Message -->
                <div id="error-message" class="hidden bg-red-800 border border-red-600 text-red-100 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline" id="error-text">An error occurred.</span>
                </div>

                <!-- Game State Display -->
                <div id="game-state-container" class="hidden">
                    <!-- This will be populated with player info -->
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const importDeckButton = document.getElementById('import-deck-button');
            const deckUrlInput = document.getElementById('deck-url-input');
            
            const importerPanel = document.getElementById('importer-panel');
            const gamePanel = document.getElementById('game-panel');

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            const gameStateContainer = document.getElementById('game-state-container');

            // --- Backend Server URL ---
            // This must point to your running backend server from 'server.js'
            const SERVER_URL = 'https://brad-mtg-server.onrender.com/create-game';

            // --- UI Control Functions ---
            const showLoader = (text) => {
                gamePanel.classList.remove('hidden');
                loaderText.textContent = text;
                loader.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                gameStateContainer.classList.add('hidden');
            };

            const hideLoader = () => {
                loader.classList.add('hidden');
            };

            const showError = (message) => {
                gamePanel.classList.remove('hidden');
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                hideLoader();
            };

            // --- Game Creation Logic ---
            const handleCreateGame = async () => {
                const url = deckUrlInput.value.trim();
                if (!url) {
                    showError('Please enter a deck URL.');
                    return;
                }
                showLoader('Creating game on server...');

                try {
                    // Send the deck URL to our new game server endpoint
                    const response = await fetch(SERVER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ deckUrl: url })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server error (${response.status})`);
                    }
                    
                    const initialGameState = await response.json();
                    
                    console.log('Received initial game state:', initialGameState);
                    displayGameState(initialGameState);

                } catch (error) {
                    if (error.message.includes('Failed to fetch')) {
                         showError("Could not connect to the game server. Make sure it's running and the URL is correct.");
                    } else {
                        showError(`Failed to create game: ${error.message}`);
                    }
                }
            };
            
            const displayGameState = (gameState) => {
                hideLoader();
                importerPanel.classList.add('hidden'); // Hide the importer
                gameStateContainer.innerHTML = ''; // Clear previous state
                
                const title = document.createElement('h2');
                title.className = "text-3xl font-bold mb-6 text-center text-gray-200";
                title.textContent = `Game Ready - Turn ${gameState.turn + 1}`;
                gameStateContainer.appendChild(title);
                
                const playersDiv = document.createElement('div');
                playersDiv.className = "grid grid-cols-1 md:grid-cols-2 gap-6";
                
                gameState.players.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = "bg-gray-700 rounded-lg p-4 shadow-lg";
                    playerCard.innerHTML = `
                        <h3 class="text-xl font-semibold text-white">${player.name}</h3>
                        <div class="mt-4 space-y-2 text-gray-300">
                            <p><strong>Life:</strong> <span class="font-mono text-lg text-green-400">${player.life}</span></p>
                            <p><strong>Hand:</strong> <span class="font-mono text-lg text-blue-400">${player.handCount}</span></p>
                            <p><strong>Library:</strong> <span class="font-mono text-lg text-yellow-400">${player.libraryCount}</span></p>
                            <p><strong>Graveyard:</strong> <span class="font-mono text-lg text-red-400">${player.graveyardCount}</span></p>
                        </div>
                    `;
                    playersDiv.appendChild(playerCard);
                });
                
                gameStateContainer.appendChild(playersDiv);
                gameStateContainer.classList.remove('hidden');
            };

            // --- Event Listeners ---
            importDeckButton.addEventListener('click', handleCreateGame);
            deckUrlInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleCreateGame());
        });
    </script>
</body>
</html>
